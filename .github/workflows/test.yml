name: Ejercicio 1 - E2E Repositorio UPT y Ejercicio 2 - Document Converter

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    timeout-minutes: 90
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox]
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
    
    - name: Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Instalar dependencias
      run: npm install
    
    - name: Instalar navegadores Playwright
      run: npx playwright install --with-deps ${{ matrix.browser }}
    
    - name: Ejecutar pruebas E2E
      run: npx playwright test --project=${{ matrix.browser }}
      env:
        CI: true
        PLAYWRIGHT_BROWSERS_PATH: 0
    
    - name: Generar reporte HTML
      if: always()
      run: npx playwright show-report --host 0.0.0.0 || true
    
    - name: Verificar resultados
      if: always()
      run: |
        if [ -f test-results/results.json ]; then
          echo "Resultados guardados exitosamente"
          cat test-results/results.json | head -20
        fi
    
    - name: Subir videos de pruebas
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: videos-${{ matrix.browser }}
        path: |
          test-results/**/*.webm
          test-results/**/*.mp4
        retention-days: 30
        if-no-files-found: ignore
        compression-level: 6
    
    - name: Subir screenshots de fallos
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: screenshots-${{ matrix.browser }}
        path: |
          test-results/**/*.png
          test-results/screenshot-*.png
          test-results/error-*.png
        retention-days: 30
        if-no-files-found: ignore
        compression-level: 6
    
    - name: Subir reporte HTML
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: report-${{ matrix.browser }}
        path: playwright-report/
        retention-days: 30
        if-no-files-found: ignore
    
    - name: Subir trazas de pruebas
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: traces-${{ matrix.browser }}
        path: test-results/**/*.zip
        retention-days: 30
        if-no-files-found: ignore
    
    - name: Subir resultados JSON
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: results-${{ matrix.browser }}
        path: |
          test-results/results.json
          test-results/junit.xml
        retention-days: 30
        if-no-files-found: ignore

  test-webkit:
    timeout-minutes: 90
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
    
    - name: Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Instalar dependencias
      run: npm install
    
    - name: Instalar navegador WebKit (Safari)
      run: npx playwright install --with-deps webkit
    
    - name: Ejecutar pruebas E2E en WebKit
      run: npx playwright test --project=webkit
      env:
        CI: true
        PLAYWRIGHT_BROWSERS_PATH: 0
    
    - name: Generar reporte HTML
      if: always()
      run: npx playwright show-report --host 0.0.0.0 || true
    
    - name: Verificar resultados
      if: always()
      run: |
        if [ -f test-results/results.json ]; then
          echo "Resultados guardados exitosamente"
          cat test-results/results.json | head -20
        fi
    
    - name: Subir videos de pruebas WebKit
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: videos-webkit
        path: |
          test-results/**/*.webm
          test-results/**/*.mp4
        retention-days: 30
        if-no-files-found: ignore
        compression-level: 6
    
    - name: Subir screenshots de fallos WebKit
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: screenshots-webkit
        path: |
          test-results/**/*.png
          test-results/screenshot-*.png
          test-results/error-*.png
        retention-days: 30
        if-no-files-found: ignore
        compression-level: 6
    
    - name: Subir reporte HTML WebKit
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: report-webkit
        path: playwright-report/
        retention-days: 30
        if-no-files-found: ignore
    
    - name: Subir trazas de pruebas WebKit
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: traces-webkit
        path: test-results/**/*.zip
        retention-days: 30
        if-no-files-found: ignore
    
    - name: Subir resultados JSON WebKit
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: results-webkit
        path: |
          test-results/results.json
          test-results/junit.xml
        retention-days: 30
        if-no-files-found: ignore

  # ============================================
  # EJERCICIO 2: Document Converter
  # ============================================
  
  ejercicio2-unit-tests:
    name: Ejercicio 2 - Pruebas Unitarias
    timeout-minutes: 30
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
    
    - name: Configurar .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Buscar archivo soluci√≥n
      run: |
        echo "Buscando archivos .sln:"
        find . -name "*.sln" -type f
        echo "Buscando ejercicio2.sln espec√≠ficamente:"
        find . -name "ejercicio2.sln" -type f
        echo "Estructura del directorio:"
        ls -la ejercicio2/ 2>/dev/null || ls -la EJERCICIO2/ 2>/dev/null || echo "No se encontr√≥ carpeta ejercicio2"
    
    - name: Restaurar dependencias
      run: |
        # Intentar diferentes rutas posibles
        if [ -f "ejercicio2/ejercicio2.sln" ]; then
          echo "Encontrado en: ejercicio2/ejercicio2.sln"
          dotnet restore ejercicio2/ejercicio2.sln
        elif [ -f "ejercicio2.sln" ]; then
          echo "Encontrado en: ejercicio2.sln (ra√≠z)"
          dotnet restore ejercicio2.sln
        elif [ -f "EJERCICIO2/ejercicio2.sln" ]; then
          echo "Encontrado en: EJERCICIO2/ejercicio2.sln"
          dotnet restore EJERCICIO2/ejercicio2.sln
        else
          # Buscar manualmente
          SOL=$(find . -name "ejercicio2.sln" -type f | head -1)
          if [ -n "$SOL" ]; then
            echo "Encontrado en: $SOL"
            dotnet restore "$SOL"
          else
            echo "ERROR: No se encontr√≥ ejercicio2.sln en ninguna ubicaci√≥n"
            exit 1
          fi
        fi
    
    - name: Compilar soluci√≥n
      run: |
        if [ -f "ejercicio2/ejercicio2.sln" ]; then
          dotnet build ejercicio2/ejercicio2.sln --no-restore -c Release
        elif [ -f "ejercicio2.sln" ]; then
          dotnet build ejercicio2.sln --no-restore -c Release
        elif [ -f "EJERCICIO2/ejercicio2.sln" ]; then
          dotnet build EJERCICIO2/ejercicio2.sln --no-restore -c Release
        else
          SOL=$(find . -name "ejercicio2.sln" -type f | head -1)
          if [ -n "$SOL" ]; then
            dotnet build "$SOL" --no-restore -c Release
          else
            echo "ERROR: No se encontr√≥ ejercicio2.sln"
            exit 1
          fi
        fi
    
    - name: Ejecutar pruebas unitarias con cobertura
      run: |
        # Buscar el proyecto de pruebas
        if [ -d "ejercicio2/tests/DocumentConverter.Tests" ]; then
          TEST_DIR="ejercicio2/tests/DocumentConverter.Tests"
          COVERAGE_DIR="ejercicio2/coverage-results"
        elif [ -d "EJERCICIO2/tests/DocumentConverter.Tests" ]; then
          TEST_DIR="EJERCICIO2/tests/DocumentConverter.Tests"
          COVERAGE_DIR="EJERCICIO2/coverage-results"
        else
          TEST_PROJ=$(find . -path "*/tests/DocumentConverter.Tests/*.csproj" | head -1)
          if [ -n "$TEST_PROJ" ]; then
            TEST_DIR="$(dirname "$TEST_PROJ")"
            COVERAGE_DIR="$(dirname "$(dirname "$TEST_DIR")")/coverage-results"
          else
            echo "ERROR: No se encontr√≥ el proyecto de pruebas"
            exit 1
          fi
        fi
        
        cd "$TEST_DIR"
        mkdir -p "$COVERAGE_DIR" || true
        
        echo "Ejecutando pruebas desde: $(pwd)"
        echo "Guardando cobertura en: $COVERAGE_DIR"
        
        dotnet test --no-build --configuration Release \
          --collect:"XPlat Code Coverage" \
          --settings:runsettings.xml \
          --results-directory:"$COVERAGE_DIR" \
          --logger:"trx;LogFileName=unit-tests.trx" \
          /p:CollectCoverage=true \
          /p:CoverletOutputFormat=cobertura,opencover,json \
          /p:CoverletOutput="$COVERAGE_DIR/coverage.xml" \
          /p:CoverletOutputDirectory="$COVERAGE_DIR"
      continue-on-error: true
    
    - name: Verificar archivos de cobertura generados
      run: |
        echo "Buscando archivos de cobertura:"
        find . -name "coverage.cobertura.xml" -o -name "coverage.xml" | head -10
        echo ""
        echo "Estructura de coverage-results:"
        find . -type d -name "*coverage*" | head -10
        ls -la ejercicio2/coverage-results/ 2>/dev/null || ls -la EJERCICIO2/coverage-results/ 2>/dev/null || echo "No se encontr√≥ coverage-results"
      continue-on-error: true
    
    - name: Generar reporte de cobertura HTML
      run: |
        # Instalar herramienta
        dotnet tool install -g dotnet-reportgenerator-globaltool || true
        
        # Buscar archivos de cobertura
        COV_FILE=$(find . -name "coverage.cobertura.xml" -o -name "coverage.xml" | head -1)
        
        if [ -z "$COV_FILE" ]; then
          echo "‚ö† No se encontr√≥ archivo de cobertura, buscando en diferentes ubicaciones..."
          find . -type f -name "*.xml" | grep -i coverage | head -5
          echo "Continuando sin reporte HTML..."
        else
          echo "Archivo de cobertura encontrado: $COV_FILE"
          
          # Determinar directorio de salida
          if [ -d "ejercicio2" ]; then
            OUTPUT_DIR="ejercicio2/coverage-reports/html"
          elif [ -d "EJERCICIO2" ]; then
            OUTPUT_DIR="EJERCICIO2/coverage-reports/html"
          else
            OUTPUT_DIR="coverage-reports/html"
          fi
          
          mkdir -p "$OUTPUT_DIR"
          
          echo "Generando reporte HTML en: $OUTPUT_DIR"
          reportgenerator \
            -reports:"$COV_FILE" \
            -targetdir:"$OUTPUT_DIR" \
            -reporttypes:"Html;Badges;JsonSummary" \
            -classfilters:"-*Tests;-*BDD" \
            -assemblyfilters:"+DocumentConverter"
          
          echo "Verificando reporte generado:"
          ls -la "$OUTPUT_DIR" | head -10 || echo "Directorio vac√≠o o no creado"
        fi
      continue-on-error: true
    
    - name: Verificar cobertura m√≠nima (80%)
      run: |
        cd ejercicio2
        python3 -c "
        import json
        import sys
        try:
            with open('coverage-reports/html/Summary.json', 'r') as f:
                data = json.load(f)
                coverage = data['summary']['linecoverage']
                print(f'Cobertura de c√≥digo: {coverage:.2f}%')
                if coverage < 80:
                    print(f'ERROR: La cobertura ({coverage:.2f}%) est√° por debajo del 80% requerido')
                    sys.exit(1)
                else:
                    print(f'‚úì Cobertura suficiente: {coverage:.2f}% >= 80%')
        except FileNotFoundError:
            print('Warning: No se encontr√≥ el archivo de resumen de cobertura')
            sys.exit(0)
        "
      continue-on-error: true
    
    - name: Verificar si existe el reporte antes de subir
      run: |
        echo "Verificando reportes disponibles para subir:"
        if [ -d "ejercicio2/coverage-reports/html" ]; then
          echo "‚úì Encontrado en: ejercicio2/coverage-reports/html"
          ls -la ejercicio2/coverage-reports/html/ | head -5
        elif [ -d "EJERCICIO2/coverage-reports/html" ]; then
          echo "‚úì Encontrado en: EJERCICIO2/coverage-reports/html"
          ls -la EJERCICIO2/coverage-reports/html/ | head -5
        else
          echo "‚ö† No se encontr√≥ reporte HTML de cobertura"
          find . -type d -name "*coverage-reports*" 2>/dev/null | head -5
        fi
      continue-on-error: true
    
    - name: Subir reporte de cobertura HTML
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ejercicio2-coverage-report
        path: |
          ejercicio2/coverage-reports/html/
          EJERCICIO2/coverage-reports/html/
          coverage-reports/html/
        retention-days: 30
        if-no-files-found: ignore
    
    - name: Subir resultados de pruebas unitarias
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ejercicio2-unit-test-results
        path: ejercicio2/coverage-results/
        retention-days: 30
        if-no-files-found: ignore

  ejercicio2-bdd-tests:
    name: Ejercicio 2 - Pruebas BDD
    timeout-minutes: 30
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
    
    - name: Configurar .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Restaurar dependencias
      run: |
        if [ -f "ejercicio2/ejercicio2.sln" ]; then
          dotnet restore ejercicio2/ejercicio2.sln
        elif [ -f "ejercicio2.sln" ]; then
          dotnet restore ejercicio2.sln
        elif [ -f "EJERCICIO2/ejercicio2.sln" ]; then
          dotnet restore EJERCICIO2/ejercicio2.sln
        else
          # Buscar proyecto BDD directamente
          BDD_PROJ=$(find . -path "*/bdd-tests/DocumentConverter.BDD/*.csproj" | head -1)
          if [ -n "$BDD_PROJ" ]; then
            dotnet restore "$BDD_PROJ"
          else
            echo "ERROR: No se encontr√≥ el proyecto BDD"
            exit 1
          fi
        fi
    
    - name: Compilar soluci√≥n
      run: |
        if [ -f "ejercicio2/ejercicio2.sln" ]; then
          dotnet build ejercicio2/ejercicio2.sln --no-restore -c Release
        elif [ -f "ejercicio2.sln" ]; then
          dotnet build ejercicio2.sln --no-restore -c Release
        elif [ -f "EJERCICIO2/ejercicio2.sln" ]; then
          dotnet build EJERCICIO2/ejercicio2.sln --no-restore -c Release
        else
          BDD_PROJ=$(find . -path "*/bdd-tests/DocumentConverter.BDD/*.csproj" | head -1)
          if [ -n "$BDD_PROJ" ]; then
            dotnet build "$BDD_PROJ" --no-restore -c Release
          fi
        fi
    
    - name: Ejecutar pruebas BDD (SpecFlow)
      run: |
        if [ -d "ejercicio2/bdd-tests/DocumentConverter.BDD" ]; then
          cd ejercicio2/bdd-tests/DocumentConverter.BDD
        elif [ -d "EJERCICIO2/bdd-tests/DocumentConverter.BDD" ]; then
          cd EJERCICIO2/bdd-tests/DocumentConverter.BDD
        else
          BDD_PROJ=$(find . -path "*/bdd-tests/DocumentConverter.BDD/*.csproj" | head -1)
          if [ -n "$BDD_PROJ" ]; then
            cd "$(dirname "$BDD_PROJ")"
          else
            echo "ERROR: No se encontr√≥ el proyecto BDD"
            exit 1
          fi
        fi
        dotnet test --no-build --configuration Release \
          --logger:"trx;LogFileName=bdd-tests.trx" \
          --logger:"html;LogFileName=bdd-report.html" \
          --results-directory:../../bdd-results
      continue-on-error: true
    
    - name: Generar reporte BDD HTML
      run: |
        cd ejercicio2
        if [ -f "bdd-results/bdd-report.html" ]; then
          mkdir -p bdd-reports/html
          cp bdd-results/bdd-report.html bdd-reports/html/ || true
        fi
      continue-on-error: true
    
    - name: Subir reporte BDD HTML
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ejercicio2-bdd-report
        path: ejercicio2/bdd-reports/
        retention-days: 30
        if-no-files-found: ignore
    
    - name: Subir resultados BDD
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ejercicio2-bdd-test-results
        path: ejercicio2/bdd-results/
        retention-days: 30
        if-no-files-found: ignore

  publish-reports:
    name: Publicar Reportes en GitHub Pages
    needs: [ejercicio2-unit-tests, ejercicio2-bdd-tests]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
    
    - name: Descargar reporte de cobertura (si existe)
      uses: actions/download-artifact@v4
      with:
        name: ejercicio2-coverage-report
        path: ejercicio2/coverage-reports/html/
        if-no-files-found: ignore
      continue-on-error: true
    
    - name: Descargar reporte BDD (si existe)
      uses: actions/download-artifact@v4
      with:
        name: ejercicio2-bdd-report
        path: ejercicio2/bdd-reports/
        if-no-files-found: ignore
      continue-on-error: true
    
    - name: Verificar qu√© artefactos se descargaron
      run: |
        echo "Verificando artefactos descargados:"
        if [ -d "ejercicio2/coverage-reports/html" ] && [ "$(ls -A ejercicio2/coverage-reports/html 2>/dev/null)" ]; then
          echo "‚úì Reporte de cobertura encontrado"
          ls -la ejercicio2/coverage-reports/html/ | head -10
        else
          echo "‚ö† Reporte de cobertura no disponible"
        fi
        
        if [ -d "ejercicio2/bdd-reports" ] && [ "$(ls -A ejercicio2/bdd-reports 2>/dev/null)" ]; then
          echo "‚úì Reporte BDD encontrado"
          ls -la ejercicio2/bdd-reports/ | head -10
        else
          echo "‚ö† Reporte BDD no disponible"
        fi
    
    - name: Configurar GitHub Pages
      uses: actions/configure-pages@v4
    
    - name: Crear estructura de reportes
      run: |
        mkdir -p reports/ejercicio2
        mkdir -p reports/ejercicio2/coverage
        mkdir -p reports/ejercicio2/bdd
        
        # Copiar reportes si existen
        if [ -d "ejercicio2/coverage-reports/html" ] && [ "$(ls -A ejercicio2/coverage-reports/html 2>/dev/null)" ]; then
          echo "Copiando reporte de cobertura..."
          cp -r ejercicio2/coverage-reports/html/* reports/ejercicio2/coverage/ 2>/dev/null || true
        else
          echo "‚ö† Reporte de cobertura no disponible, creando placeholder"
          echo "<html><body><h1>Reporte de Cobertura</h1><p>El reporte no est√° disponible en este momento. Las pruebas pueden haber fallado o el artefacto no se gener√≥.</p></body></html>" > reports/ejercicio2/coverage/index.html
        fi
        
        if [ -d "ejercicio2/bdd-reports" ] && [ "$(ls -A ejercicio2/bdd-reports 2>/dev/null)" ]; then
          echo "Copiando reporte BDD..."
          cp -r ejercicio2/bdd-reports/* reports/ejercicio2/bdd/ 2>/dev/null || true
        else
          echo "‚ö† Reporte BDD no disponible, creando placeholder"
          echo "<html><body><h1>Reporte BDD</h1><p>El reporte no est√° disponible en este momento. Las pruebas pueden haber fallado o el artefacto no se gener√≥.</p></body></html>" > reports/ejercicio2/bdd/index.html
        fi
        
        # Crear p√°gina √≠ndice
        cat > reports/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>Reportes de Pruebas - Ejercicio 2</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; background: #f9f9f9; }
                h1 { color: #333; }
                .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                .report-link { 
                    display: block; 
                    margin: 20px 0; 
                    padding: 20px; 
                    background: #f5f5f5; 
                    border-radius: 5px; 
                    text-decoration: none; 
                    color: #0066cc;
                    border-left: 4px solid #0066cc;
                    transition: all 0.3s;
                }
                .report-link:hover { 
                    background: #e0e0e0; 
                    transform: translateX(5px);
                }
                .warning { 
                    padding: 15px; 
                    background: #fff3cd; 
                    border-left: 4px solid #ffc107; 
                    margin: 20px 0;
                    border-radius: 4px;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üìä Reportes de Pruebas - Ejercicio 2</h1>
                <h2>Document Converter Tests</h2>
                
                <div class="warning">
                    <strong>Nota:</strong> Si los reportes no est√°n disponibles, puede que las pruebas hayan fallado o los artefactos no se hayan generado correctamente. Revisa la pesta√±a "Actions" para m√°s detalles.
                </div>
                
                <a href="ejercicio2/coverage/index.html" class="report-link">
                    üìä Reporte de Cobertura de C√≥digo
                </a>
                <a href="ejercicio2/bdd/index.html" class="report-link">
                    üß™ Reporte de Pruebas BDD (SpecFlow)
                </a>
            </div>
        </body>
        </html>
        EOF
    
    - name: Subir a GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: reports
    
    - name: Desplegar a GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

